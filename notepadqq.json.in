{
    "app-id": "com.notepadqq.Notepadqq",
    //"branch": "stable",
    // https://github.com/flathub/io.qt.qtwebkit.BaseApp
    // https://github.com/flathub/io.qt.qtwebkit.BaseApp/blob/master/io.qt.qtwebkit.BaseApp.json
    "base": "io.qt.qtwebkit.BaseApp",
    "base-version": "stable",
    "runtime": "org.kde.Platform",
    "runtime-version": "5.9",
    //"runtime-version": "5.10",
    "sdk": "org.kde.Sdk",
    "command": "notepadqq",
    "rename-icon": "notepadqq",
    "rename-desktop-file": "notepadqq.desktop",
    "rename-appdata-file": "notepadqq.appdata.xml",
    "finish-args": [
        // X11 + XShm access
        "--share=ipc",
        "--socket=x11",
        // Wayland access
        "--socket=wayland",
        // Play sounds
        "--socket=pulseaudio",
        //"--socket=system-bus",
        //"--socket=session-bus",
        // Needs to talk to the network
        "--share=network",
        //"--filesystem=home",
        //"--filesystem=/run/media",
        //"--filesystem=/tmp",
        "--filesystem=host",
        // Needed for dconf to work
        "--filesystem=xdg-run/dconf", "--filesystem=~/.config/dconf:ro",
        //"--filesystem=xdg-run/dconf", "--filesystem=~/.config/dconf:rw",
        "--talk-name=ca.desrt.dconf", "--env=DCONF_USER_CONFIG_DIR=.config/dconf",
        // Notifications
        //"--talk-name=org.freedesktop.Notifications",
        //"--talk-name=org.freedesktop.secrets",
        //"--system-talk-name=org.freedesktop.GeoClue2",
        // https://github.com/lirios/browser/issues/77
        // https://lists.freedesktop.org/archives/flatpak/2017-June/000722.html
        // [3:3:0507/024514.824467:INFO:zygote_host_impl_linux.cc(107)] No usable sandbox! Update your kernel or see https://chromium.googlesource.com/chromium/src/+/master/docs/linux_suid_sandbox_development.md for more information on developing with the SUID sandbox. If you want to live dangerously and need an immediate workaround, you can try using --no-sandbox.
        "--env=QTWEBENGINE_DISABLE_SANDBOX=1",
        //"--env=QT_XCB_FORCE_SOFTWARE_OPENGL=1",
        // Available platform plugins are: eglfs, linuxfb, minimal, minimalegl, offscreen, vnc, xcb.
        //"--env=QT_QPA_PLATFORM=flatpak",
        //"--env=LC_ALL=C",
        //"--device=all",
        // OpenGL access
        "--device=dri"
    ],
    "build-options" : {
        "cflags": "-O2 -g -Wno-deprecated-declarations -fstack-protector-strong -D_FORTIFY_SOURCE=2",
        "cxxflags": "-O2 -g -Wno-deprecated-declarations -fstack-protector-strong -D_FORTIFY_SOURCE=2",
        "ldflags": "-fstack-protector-strong -Wl,-z,relro,-z,now",
        "env": {
            "V": "1"
        }
    },
    "modules": [
        {
            "name": "xmlstarlet",
            "config-opts": [
                // We don't need it after complete build
                "--prefix=/app/opt/xmlstarlet",
                "--exec-prefix=/app/opt/xmlstarlet",
                "--disable-static-libs",
                "--with-libxml-libs-prefix=/usr/lib",
                "--with-libxml-include-prefix=/usr/include/libxml2"
            ],
            // remove configure script to run autoreconf
            //"rm-configure": true,
            "sources": [
                {
                    "type": "archive",
                    "url": "http://downloads.sourceforge.net/xmlstar/xmlstarlet-1.6.1.tar.gz",
                    "sha256": "15d838c4f3375332fd95554619179b69e4ec91418a3a5296e7c631b7ed19e7ca"
                },
                // checking for xml2-config... /bin/xml2-config
                // ERROR: /usr/bin/xml2-config should not be used, use an alternative such as pkg-config
                // configure: error: xmlstarlet needs at least libxml version 2.6.27 (http://www.xmlsoft.org/)
                // Error: module xmlstarlet: Child process exited with code 1
                // checking for xslt-config... /bin/xslt-config
                // ERROR: /usr/bin/xslt-config should not be used, use an alternative such as pkg-config
                // configure: error: xmlstarlet needs at least libxslt version 1.1.9 (http://www.xmlsoft.org/)
                // Error: module xmlstarlet: Child process exited with code 1
                {
                    "type": "shell",
                    "commands": [
                        "sed -r -i 's/^([[:blank:]]*XSTAR_LIB_CHECK[[:blank:]]*\\(\\[LIBXML\\],[[:blank:]]*\\[)xml2-config(\\]\\))/\\1pkg-config libxml-2.0\\2/' 'configure.ac';",
                        "sed -r -i 's/^([[:blank:]]*XSTAR_LIB_CHECK[[:blank:]]*\\(\\[LIBXSLT\\],[[:blank:]]*\\[)xslt-config(\\]\\))/\\1pkg-config libxslt\\2/' 'configure.ac';",
                        "grep -Ei 'XSTAR_LIB_CHECK' 'configure.ac' || :;"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "sed -r -i 's/^(\\[LIBXML_REQUIRED_VERSION=)/#\\1/' 'configure.ac';",
                        "sed -r -i 's/^(\\[LIBXSLT_REQUIRED_VERSION=)/#\\1/' 'configure.ac';",
                        "grep -Ei '_REQUIRED_VERSION' 'configure.ac' || :;"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "autoreconf -i;"
                    ]
                }
            ],
            "post-install": [
                // symlink
                "echo 'post-install: symlink';",
                "[[ -f '/app/opt/xmlstarlet/bin/xmlstarlet' ]] || ln -s 'xml' '/app/opt/xmlstarlet/bin/xmlstarlet';"
            ],
            "cleanup": [
                "/opt/xmlstarlet/share/doc",
                "/opt/xmlstarlet/share/man"
            ]
        },
        /*{
            "name": "imagemagick",
            "config-opts": [
                // We don't need it after complete build
                "--prefix=/app/opt/imagemagick",
                "--exec-prefix=/app/opt/imagemagick",
                "--with-rsvg",
                "--disable-static"
            ],
            "sources": [
                {
                    "type": "archive",
                    //"url": "https://www.imagemagick.org/download/ImageMagick-6.9.9-41.tar.xz",
                    //"sha256": "35b52173c240f81654368a5c453614f572fcb44132531a8fa4538e2d304adfd3"
                    //"url": "https://www.imagemagick.org/download/ImageMagick-6.9.9-42.tar.xz",
                    //"sha256": "873654cd55792cdaa9c3ee35f63e389fedfb3d34685a1f77d6b81e5c578ae527"
                    "url": "https://www.imagemagick.org/download/ImageMagick-6.9.9-43.tar.xz",
                    "sha256": "66c2937728ae3f385d84691a360d74993675f43ae16236773daa3a49c3ea6e27"
                }
            ],
            "cleanup": [
                "/opt/imagemagick/share/doc",
                "/opt/imagemagick/share/man"
            ]
        },//*/
        // The "buildsystem": "cmake-ninja" isn't available in flatpak 0.8.x in EL7 7.5
        // https://github.com/flatpak/flatpak/issues/461
        // https://github.com/matthiasclasen/flatpak/commit/75ae3d946e9787af3fb3281aedcb19358eb5bcfb
        // see also: "base": "io.qt.qtwebkit.BaseApp"
        /*{
            //"name": "qtwebkit",
            "name": "qt5-webkit",
            //"buildsystem": "cmake-ninja",
            "buildsystem": "cmake",
            "builddir": true,
            "config-opts": [
                "-DCMAKE_INSTALL_LIBDIR=lib",
                "-DPORT=Qt",
                "-DENABLE_API_TESTS=OFF",
                "-DENABLE_INSPECTOR_UI=OFF",
                "-DENABLE_LEGACY_WEB_AUDIO=OFF",
                "-DENABLE_MEDIA_SOURCE=OFF",
                "-DENABLE_NETSCAPE_PLUGIN_API=OFF",
                "-DENABLE_PRINT_SUPPORT=OFF",
                "-DENABLE_SAMPLING_PROFILER=OFF",
                "-DENABLE_SPELLCHECK=OFF",
                "-DENABLE_VIDEO=OFF",
                "-DENABLE_WEBKIT2=OFF",
                "-DENABLE_WEB_AUDIO=OFF",
                "-DUSE_GSTREAMER=OFF"
            ],
            "post-install": [
                "mv '/app/mkspecs' '/app/lib';"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/annulen/webkit/releases/download/qtwebkit-5.212.0-alpha2/qtwebkit-5.212.0-alpha2.tar.xz",
                    "sha256": "f8f901de567e11fc5659402b6b827eac75505ff9c5072d8e919aa306003f8f8a"
                }
            ]
        },//*/
        /*"qtwebkit.json",//*/
        {
            "name": "notepadqq",
            //"config-opts": [
            //    "--prefix=/app"
            //],
            "no-autogen": true,
            "sources": [
                {
                    "type": "archive",
                    //"url": "https://github.com/notepadqq/notepadqq/archive/v1.4.0.tar.gz",
                    //"sha256": "f295353224848c06fafcc71c7f6a38780a98890075ab33f0179181ebf21bad08"
                    "url": "https://github.com/notepadqq/notepadqq/archive/v1.4.4.tar.gz",
                    "sha256": "b071646c1447b57c128cd2ca19fc3e43c23e91f4e784223aa84486350a30d02c"
                },
                {
                    "type": "shell",
                    "commands": [
                        "mkdir -p 'src/editor/libs/codemirror/mode/m4';"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        //"ln -s /app/include/QtWebKitWidgets/qwebframe.h /app/include/QtWebKitWidgets/QWebFrame.h;",
                        "export QMAKEPATH=QMAKEPATH:/app/lib && qmake QMAKE_CFLAGS_DEBUG=\"${CFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_CFLAGS_RELEASE=\"${CFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_CXXFLAGS_DEBUG=\"${CXXFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_CXXFLAGS_RELEASE=\"${CXXFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_LFLAGS_DEBUG=\"${LDFLAGS:--Wl,-z,relro }\" QMAKE_LFLAGS_RELEASE=\"${LDFLAGS:--Wl,-z,relro }\" QMAKE_STRIP= PREFIX=/app \"INCLUDEPATH+=/app/include/QtWebKitWidgets\" \"INCLUDEPATH+=/app/include/QtWebKit\" \"QMAKE_LIBDIR+=/app/lib\" LRELEASE=lrelease *.pro;",
                        "export QMAKEPATH=QMAKEPATH:/app/lib && make -j$(nproc);",
                        "make install;",
                        "echo '# Empty makefile\n\nall:\n\techo \"Using an empty makefile doing nothing\"\n\ninstall:\n\techo \"Using an empty makefile doing nothing\"' > Makefile;"
                    ]
                }
            ],
            "post-install": [
                // manuals
                "echo 'post-install: symlink';",
                "ln -sf '/app/lib/notepadqq/notepadqq-bin' '/app/bin/notepadqq'",
                // desktop files
                "echo 'post-install: desktop files';",
                "app_id='com.notepadqq.Notepadqq';
                desktop-file-edit --set-key=Icon --set-value=\"${app_id}\" /app/share/applications/*.desktop;
                desktop-file-edit --remove-key=OnlyShowIn /app/share/applications/*.desktop;", /**/
                // metainfo/appdata - https://fedoraproject.org/wiki/Packaging:AppData
                "echo 'post-install: metainfo';",
                "echo 'setting up xmlstarlet';
                xmlstarlet_home='/app/opt/xmlstarlet';
                xmlstarlet_bin=\"${xmlstarlet_home}/bin\";
                if [[ -n \"${PATH}\" ]]; then
                  PATH=\"${PATH}:${xmlstarlet_bin}\";
                else
                  PATH=\"${xmlstarlet_bin}\";
                fi;
                export PATH;
                app_version=\"$( grep -Ei \"^[[:blank:]]*version[[:blank:]]*:[[:blank:]]*'([^']*)'*[[:blank:]]*$\" 'snap/snapcraft.yaml' 2>/dev/null | tail -n 1 2>/dev/null | sed -re \"s/^[[:blank:]]*version[[:blank:]]*:[[:blank:]]*'([^']*)'*[[:blank:]]*$/\\1/\" 2>/dev/null || : )\";
                app_date=\"$( date --reference 'src' -u '+%Y-%m-%d' 2>/dev/null || : )\";
                find '/app/share/metainfo' -mindepth 1 -maxdepth 1 -xtype f -name '*.appdata.xml' | sort -V | while read -r filename; do
                    echo 'fixing xml declaration';
                    sed -r -i '1 s/^[[:blank:]]+//' \"${filename}\" || :;
                    echo 'removing invalid tag';
                    xmlstarlet ed --inplace -d '/component/icon' \"${filename}\" || :;
                    if [[ -n \"${app_version}\" && -n \"${app_date}\" ]]; then
                        need_fix='0';
                        xmlstarlet sel -t -v '/component/releases/release/@version' \"${filename}\" || need_fix='1';
                        if [[ \"${need_fix}\" -ne \"0\" ]]; then
                            echo 'updating release info';
                            xmlstarlet ed --inplace -d '/component/releases' -s '/component' -t elem -n 'releases' -s '/component/releases' -t elem -n 'release' -s '/component/releases/release' -t attr -n 'date' -v \"${app_date}\" -s '/component/releases/release' -t attr -n 'version' -v \"${app_version}\" \"${filename}\";
                            xmlstarlet sel -t -c '/component/releases/release' \"${filename}\" | sed -re 's/$/\\n/' || :;
                        fi;
                    fi;
                    app_id='com.notepadqq.Notepadqq';
                    if [[ -n \"${app_id}\" ]]; then
                        xmlstarlet ed --inplace -d '/component/id' -s '/component' -t elem -n 'id' -v \"${app_id}\" \"${filename}\";
                        need_fix='0';
                        xmlstarlet sel -t -v '/component/launchable' \"${filename}\" || need_fix='2';
                        if [[ \"${need_fix}\" -ne \"0\" ]]; then
                            echo 'adding additional tags';
                            xmlstarlet ed --inplace -d '/component/launchable' -s '/component' -t elem -n 'launchable' -v \"${app_id}\" -s '/component/launchable' -t attr -n 'type' -v 'desktop-id' \"${filename}\";
                            xmlstarlet sel -t -c '/component/launchable' \"${filename}\" | sed -re 's/$/\\n/' || :;
                        fi;
                    fi;
                done;",
                // validate data
                "echo 'post-install: validate data';",
                "cat /app/share/applications/*.desktop;",
                "desktop-file-validate /app/share/applications/*.desktop || :;",
                "cat /app/share/metainfo/*.appdata.xml;",
                "appstream-util validate-relax --nonet /app/share/metainfo/*.appdata.xml || :;"
            ]
        }
    ],
    "cleanup": [
        //"/cache",
        "/include",
        "/lib/pkgconfig",
        "/share/cmake",
        "/man",
        "/share/man",
        "/lib/systemd",
        "/opt",
        "*.la",
        "*.a"
    ]
}

