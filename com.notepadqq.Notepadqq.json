{
    "app-id": "com.notepadqq.Notepadqq",
    "base": "io.qt.qtwebkit.BaseApp",
    "base-version": "stable",
    "runtime": "org.kde.Platform",
    "runtime-version": "5.9",
    "sdk": "org.kde.Sdk",
    "command": "notepadqq",
    "rename-icon": "notepadqq",
    "rename-desktop-file": "notepadqq.desktop",
    "rename-appdata-file": "notepadqq.appdata.xml",
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--share=network",
        "--filesystem=host",
        "--filesystem=xdg-run/dconf", "--filesystem=~/.config/dconf:ro",
        "--talk-name=ca.desrt.dconf", "--env=DCONF_USER_CONFIG_DIR=.config/dconf",
        "--env=QTWEBENGINE_DISABLE_SANDBOX=1",
        "--device=dri"
    ],
    "build-options" : {
        "cflags": "-O2 -g -Wno-deprecated-declarations -fstack-protector-strong -D_FORTIFY_SOURCE=2",
        "cxxflags": "-O2 -g -Wno-deprecated-declarations -fstack-protector-strong -D_FORTIFY_SOURCE=2",
        "ldflags": "-fstack-protector-strong -Wl,-z,relro,-z,now",
        "env": {
            "V": "1"
        }
    },
    "modules": [
        {
            "name": "xmlstarlet",
            "config-opts": [
                "--prefix=/app/opt/xmlstarlet",
                "--exec-prefix=/app/opt/xmlstarlet",
                "--disable-static-libs",
                "--with-libxml-libs-prefix=/usr/lib",
                "--with-libxml-include-prefix=/usr/include/libxml2"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://downloads.sourceforge.net/xmlstar/xmlstarlet-1.6.1.tar.gz",
                    "sha256": "15d838c4f3375332fd95554619179b69e4ec91418a3a5296e7c631b7ed19e7ca"
                },
                {
                    "type": "shell",
                    "commands": [
                        "sed -r -i 's/^([[:blank:]]*XSTAR_LIB_CHECK[[:blank:]]*\\(\\[LIBXML\\],[[:blank:]]*\\[)xml2-config(\\]\\))/\\1pkg-config libxml-2.0\\2/' 'configure.ac';",
                        "sed -r -i 's/^([[:blank:]]*XSTAR_LIB_CHECK[[:blank:]]*\\(\\[LIBXSLT\\],[[:blank:]]*\\[)xslt-config(\\]\\))/\\1pkg-config libxslt\\2/' 'configure.ac';",
                        "grep -Ei 'XSTAR_LIB_CHECK' 'configure.ac' || :;"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "sed -r -i 's/^(\\[LIBXML_REQUIRED_VERSION=)/#\\1/' 'configure.ac';",
                        "sed -r -i 's/^(\\[LIBXSLT_REQUIRED_VERSION=)/#\\1/' 'configure.ac';",
                        "grep -Ei '_REQUIRED_VERSION' 'configure.ac' || :;"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "autoreconf -i;"
                    ]
                }
            ],
            "post-install": [
                "echo 'post-install: symlink';",
                "[[ -f '/app/opt/xmlstarlet/bin/xmlstarlet' ]] || ln -s 'xml' '/app/opt/xmlstarlet/bin/xmlstarlet';"
            ],
            "cleanup": [
                "/opt/xmlstarlet/share/doc",
                "/opt/xmlstarlet/share/man"
            ]
        },
        {
            "name": "notepadqq",
            "no-autogen": true,
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/notepadqq/notepadqq/archive/v1.4.4.tar.gz",
                    "sha256": "b071646c1447b57c128cd2ca19fc3e43c23e91f4e784223aa84486350a30d02c"
                },
                {
                    "type": "shell",
                    "commands": [
                        "mkdir -p 'src/editor/libs/codemirror/mode/m4';"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "export QMAKEPATH=QMAKEPATH:/app/lib && qmake QMAKE_CFLAGS_DEBUG=\"${CFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_CFLAGS_RELEASE=\"${CFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_CXXFLAGS_DEBUG=\"${CXXFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_CXXFLAGS_RELEASE=\"${CXXFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic }\" QMAKE_LFLAGS_DEBUG=\"${LDFLAGS:--Wl,-z,relro }\" QMAKE_LFLAGS_RELEASE=\"${LDFLAGS:--Wl,-z,relro }\" QMAKE_STRIP= PREFIX=/app \"INCLUDEPATH+=/app/include/QtWebKitWidgets\" \"INCLUDEPATH+=/app/include/QtWebKit\" \"QMAKE_LIBDIR+=/app/lib\" LRELEASE=lrelease *.pro;",
                        "export QMAKEPATH=QMAKEPATH:/app/lib && make -j$(nproc);",
                        "make install;",
                        "echo '# Empty makefile\n\nall:\n\techo \"Using an empty makefile doing nothing\"\n\ninstall:\n\techo \"Using an empty makefile doing nothing\"' > Makefile;"
                    ]
                }
            ],
            "post-install": [
                "echo 'post-install: symlink';",
                "ln -sf '/app/lib/notepadqq/notepadqq-bin' '/app/bin/notepadqq'",
                "echo 'post-install: desktop files';",
                "app_id='com.notepadqq.Notepadqq';
                desktop-file-edit --set-key=Icon --set-value=\"${app_id}\" /app/share/applications/*.desktop;
                desktop-file-edit --remove-key=OnlyShowIn /app/share/applications/*.desktop;", 
                "echo 'post-install: metainfo';",
                "echo 'setting up xmlstarlet';
                xmlstarlet_home='/app/opt/xmlstarlet';
                xmlstarlet_bin=\"${xmlstarlet_home}/bin\";
                if [[ -n \"${PATH}\" ]]; then
                  PATH=\"${PATH}:${xmlstarlet_bin}\";
                else
                  PATH=\"${xmlstarlet_bin}\";
                fi;
                export PATH;
                app_version=\"$( grep -Ei \"^[[:blank:]]*version[[:blank:]]*:[[:blank:]]*'([^']*)'*[[:blank:]]*$\" 'snap/snapcraft.yaml' 2>/dev/null | tail -n 1 2>/dev/null | sed -re \"s/^[[:blank:]]*version[[:blank:]]*:[[:blank:]]*'([^']*)'*[[:blank:]]*$/\\1/\" 2>/dev/null || : )\";
                app_date=\"$( date --reference 'src' -u '+%Y-%m-%d' 2>/dev/null || : )\";
                find '/app/share/metainfo' -mindepth 1 -maxdepth 1 -xtype f -name '*.appdata.xml' | sort -V | while read -r filename; do
                    echo 'fixing xml declaration';
                    sed -r -i '1 s/^[[:blank:]]+//' \"${filename}\" || :;
                    echo 'removing invalid tag';
                    xmlstarlet ed --inplace -d '/component/icon' \"${filename}\" || :;
                    if [[ -n \"${app_version}\" && -n \"${app_date}\" ]]; then
                        need_fix='0';
                        xmlstarlet sel -t -v '/component/releases/release/@version' \"${filename}\" || need_fix='1';
                        if [[ \"${need_fix}\" -ne \"0\" ]]; then
                            echo 'updating release info';
                            xmlstarlet ed --inplace -d '/component/releases' -s '/component' -t elem -n 'releases' -s '/component/releases' -t elem -n 'release' -s '/component/releases/release' -t attr -n 'date' -v \"${app_date}\" -s '/component/releases/release' -t attr -n 'version' -v \"${app_version}\" \"${filename}\";
                            xmlstarlet sel -t -c '/component/releases/release' \"${filename}\" | sed -re 's/$/\\n/' || :;
                        fi;
                    fi;
                    app_id='com.notepadqq.Notepadqq';
                    if [[ -n \"${app_id}\" ]]; then
                        xmlstarlet ed --inplace -d '/component/id' -s '/component' -t elem -n 'id' -v \"${app_id}\" \"${filename}\";
                        need_fix='0';
                        xmlstarlet sel -t -v '/component/launchable' \"${filename}\" || need_fix='2';
                        if [[ \"${need_fix}\" -ne \"0\" ]]; then
                            echo 'adding additional tags';
                            xmlstarlet ed --inplace -d '/component/launchable' -s '/component' -t elem -n 'launchable' -v \"${app_id}\" -s '/component/launchable' -t attr -n 'type' -v 'desktop-id' \"${filename}\";
                            xmlstarlet sel -t -c '/component/launchable' \"${filename}\" | sed -re 's/$/\\n/' || :;
                        fi;
                    fi;
                done;",
                "echo 'post-install: validate data';",
                "cat /app/share/applications/*.desktop;",
                "desktop-file-validate /app/share/applications/*.desktop || :;",
                "cat /app/share/metainfo/*.appdata.xml;",
                "appstream-util validate-relax --nonet /app/share/metainfo/*.appdata.xml || :;"
            ]
        }
    ],
    "cleanup": [
        "/include",
        "/lib/pkgconfig",
        "/share/cmake",
        "/man",
        "/share/man",
        "/lib/systemd",
        "/opt",
        "*.la",
        "*.a"
    ]
}
